<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>JWT Auth with Counter</title>    <style>        body {            font-family: Arial, sans-serif;            max-width: 600px;            margin: 50px auto;            text-align: center;            padding: 20px;        }        input {            width: 90%;            padding: 10px;            margin: 10px 0;            border: 1px solid #ccc;            border-radius: 5px;        }        button {            padding: 10px;            width: 100%;            border: none;            background-color: #28a745;            color: white;            cursor: pointer;            margin: 10px 0;            border-radius: 5px;        }        button.logout {            background-color: #dc3545;        }        button.increment {            background-color: #007bff;            margin-bottom: 20px;        }        #message {            margin-top: 10px;            font-weight: bold;            color: #dc3545;        }        .token-display {            word-break: break-all;            background: #f8f9fa;            padding: 15px;            border-radius: 5px;            margin: 10px 0;            text-align: left;            font-family: monospace;        }        .counter {            font-size: 24px;            font-weight: bold;            margin: 20px 0;            padding: 10px;            background: #e9ecef;            border-radius: 5px;        }        #emailSentMessage {            color: #28a745;            font-weight: bold;            padding: 10px;            margin: 10px 0;            background-color: #d4edda;            border-radius: 5px;            display: none;        }    </style></head><body><h2>JWT Authentication</h2><div id="loginForm">    <input type="text" id="email" placeholder="email">    <button onclick="login()">Login</button>    <div id="emailSentMessage">Magic link has been sent to your email!</div></div><div id="logoutSection" style="display:none;">    <p>Logged in as: <span id="user"></span></p>    <div class="token-display">        <strong>JWT Token:</strong>        <p id="jwtToken" style="margin: 5px 0;"></p>    </div>    <p>Browser ID: <span id="browserId"></span></p>    <div class="counter">        Counter: <span id="counter">0</span>    </div>    <button class="increment" onclick="incrementCounter()">Increment Counter</button>    <button class="logout" onclick="logout(false)">Logout from this browser</button>    <button class="logout" onclick="logout(true)" style="background-color: #bd2130;">Logout from all browsers</button></div><p id="message"></p><script>    const API_URL = "http://localhost:8083/v1/auth";    function getBrowserId() {        let browserId = localStorage.getItem('browserId');        if (!browserId) {            browserId = 'browser_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);            localStorage.setItem('browserId', browserId);        }        return browserId;    }    function updateCounter(count) {        document.getElementById("counter").textContent = count;    }    async function incrementCounter() {        const token = localStorage.getItem("jwtToken");        if (!token) return;        try {            const response = await fetch(`${API_URL}/increment`, {                method: "POST",                headers: {                    "Content-Type": "application/json"                },                body: JSON.stringify({ token })            });            const data = await response.json();            if (data.success) {                updateCounter(data.count);                // Broadcast counter update to other tabs                localStorage.setItem('counterUpdate', data.count.toString());            }        } catch (error) {            console.error("Error incrementing counter:", error);        }    }    async function login() {        const email = document.getElementById("email").value;        const browserId = getBrowserId();        try {            const response = await fetch(`${API_URL}/login`, {                method: "POST",                headers: { "Content-Type": "application/json" },                body: JSON.stringify({ email, browserId })            });            const data = await response.json();            if (!data.error) {                document.getElementById("emailSentMessage").style.display = "block";                document.getElementById("message").innerText = "";            } else {                document.getElementById("emailSentMessage").style.display = "none";                document.getElementById("message").innerText = "Invalid email!";            }        } catch (error) {            console.error("Login error:", error);            document.getElementById("message").innerText = "Login failed!";        }    }    async function logout(logoutAll) {        const email = localStorage.getItem("email");        const browserId = getBrowserId();        try {            const response = await fetch(`${API_URL}/logout`, {                method: "POST",                headers: {                    "Content-Type": "application/json"                },                body: JSON.stringify({                    username: email,                    browserId: browserId,                    logoutAll: logoutAll                })            });            const data = await response.json();            if (data.success) {                localStorage.removeItem("jwtToken");                localStorage.removeItem("email");                if (logoutAll) {                    localStorage.removeItem("browserId");                }                showLogin();                // Notify other tabs about the logout                localStorage.setItem('authEvent', Date.now().toString());            }        } catch (error) {            console.error("Logout error:", error);            document.getElementById("message").innerText = "Logout failed!";        }    }    async function checkAuth() {        const urlParams = new URLSearchParams(window.location.search);        const token = urlParams.get('token') || localStorage.getItem("jwtToken");        const email = urlParams.get('email') || localStorage.getItem("email");        const browserId = getBrowserId();        if (!token) {            return showLogin();        }        try {            const response = await fetch(`${API_URL}/validate?token=${token}&browserId=${browserId}`);            const data = await response.json();            if (data.token) {                localStorage.setItem("jwtToken", data.token);                localStorage.setItem("email", email);                updateCounter(data.counter);                showLogout();                // Clear URL parameters after successful login                if (urlParams.has('token')) {                    window.history.replaceState({}, document.title, window.location.pathname);                }            } else {                localStorage.removeItem("jwtToken");                localStorage.removeItem("email");                showLogin();            }        } catch (error) {            localStorage.removeItem("jwtToken");            localStorage.removeItem("email");            showLogin();        }    }    function showLogout() {        try {            const email = localStorage.getItem("email");            const token = localStorage.getItem("jwtToken");            const browserId = getBrowserId();            document.getElementById("user").innerText = email;            document.getElementById("jwtToken").innerText = token;            document.getElementById("browserId").innerText = browserId;            document.getElementById("loginForm").style.display = "none";            document.getElementById("logoutSection").style.display = "block";            document.getElementById("message").innerText = "";        } catch (error) {            console.error("Error in showLogout:", error);        }    }    function showLogin() {        document.getElementById("loginForm").style.display = "block";        document.getElementById("logoutSection").style.display = "none";        document.getElementById("message").innerText = "";        document.getElementById("counter").textContent = "0";        document.getElementById("emailSentMessage").style.display = "none";    }    // Listen for auth changes and counter updates in other tabs    window.addEventListener('storage', (event) => {        if (event.key === 'authEvent') {            checkAuth();        } else if (event.key === 'counterUpdate') {            updateCounter(parseInt(event.newValue));        }    });    // Check auth on page load    document.addEventListener('DOMContentLoaded', checkAuth);</script></body></html>