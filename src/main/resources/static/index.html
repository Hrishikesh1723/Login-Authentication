<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>JWT Auth with Counter</title>    <style>        body {            font-family: Arial, sans-serif;            max-width: 600px;            margin: 50px auto;            text-align: center;            padding: 20px;        }        input {            width: 90%;            padding: 10px;            margin: 10px 0;            border: 1px solid #ccc;            border-radius: 5px;        }        button {            padding: 10px;            width: 100%;            border: none;            background-color: #28a745;            color: white;            cursor: pointer;            margin: 10px 0;            border-radius: 5px;        }        button.logout {            background-color: #dc3545;        }        button.increment {            background-color: #007bff;            margin-bottom: 20px;        }        #message {            margin-top: 10px;            font-weight: bold;            color: #dc3545;        }        .token-display {            word-break: break-all;            background: #f8f9fa;            padding: 15px;            border-radius: 5px;            margin: 10px 0;            text-align: left;            font-family: monospace;        }        .counter {            font-size: 24px;            font-weight: bold;            margin: 20px 0;            padding: 10px;            background: #e9ecef;            border-radius: 5px;        }        #emailSentMessage {            color: #28a745;            font-weight: bold;            padding: 10px;            margin: 10px 0;            background-color: #d4edda;            border-radius: 5px;            display: none;        }        .user-list {            width: 80%;            margin: 20px auto;            font-family: Arial, sans-serif;        }        table {            width: 100%;            border-collapse: collapse;            margin-top: 10px;        }        th, td {            border: 1px solid #ddd;            padding: 10px;            text-align: left;        }        th {            background-color: #f4f4f4;        }        tr:nth-child(even) {            background-color: #f9f9f9;        }        tr:hover {            background-color: #f1f1f1;        }    </style></head><body><h2>JWT Authentication</h2><div id="loginForm">    <input type="text" id="email" placeholder="email">    <button onclick="login()">Login</button>    <div id="emailSentMessage">Magic link has been sent to your email!</div></div><div id="adminSection" style="display:none;">    <p>Logged in as: <span id="adminUser"></span> (Admin)</p>    <div class="token-display">        <strong>JWT Token:</strong>        <p id="adminJwtToken"></p>    </div>    <div class="counter">        Counter: <span id="adminCounter">0</span>    </div>    <button class="increment" onclick="incrementCounter()">Increment Counter</button>    <div class="admin-section">        <h3>Add New User</h3>        <input type="text" id="newUserEmail" placeholder="Email">        <input type="text" id="newUsername" placeholder="Username">        <button onclick="addUser()">Add User</button>    </div>    <div class="user-list">        <h3>User List</h3>        <table id="userTable">            <thead>            <tr>                <th>Email</th>                <th>Username</th>                <th>Role</th>                <th>Counter</th>            </tr>            </thead>            <tbody id="userList">            <!-- User data will be dynamically inserted here -->            </tbody>        </table>    </div>    <button class="logout" onclick="logout(false)">Logout from this browser</button>    <button class="logout" onclick="logout(true)">Logout from all browsers</button></div><div id="userSection" style="display:none;">    <p>Logged in as: <span id="userUsername"></span></p>    <div class="token-display">        <strong>JWT Token:</strong>        <p id="userJwtToken"></p>    </div>    <div class="counter">        Counter: <span id="userCounter">0</span>    </div>    <button class="increment" onclick="incrementCounter()">Increment Counter</button>    <button class="logout" onclick="logout(false)">Logout from this browser</button>    <button class="logout" onclick="logout(true)">Logout from all browsers</button></div><p id="message"></p><script>    const API_URL = "http://localhost:8083/v1/auth";    let currentUserRole = null;    let currentToken = null;    async function login() {        const email = document.getElementById("email").value;        const browserId = getBrowserId();        try {            const response = await fetch(`${API_URL}/login`, {                method: "POST",                headers: { "Content-Type": "application/json" },                body: JSON.stringify({ email, browserId })            });            const data = await response.json();            if (!data.error) {                document.getElementById("emailSentMessage").style.display = "block";                document.getElementById("message").innerText = "";            } else {                document.getElementById("emailSentMessage").style.display = "none";                document.getElementById("message").innerText = "Invalid email!";            }        } catch (error) {            console.error("Login error:", error);            document.getElementById("message").innerText = "Login failed!";        }    }    async function addUser() {        const email = document.getElementById("newUserEmail").value;        const username = document.getElementById("newUsername").value;        try {            const response = await fetch(`${API_URL}/add-user`, {                method: "POST",                headers: {                    "Content-Type": "application/json",                    "Authorization": `Bearer ${currentToken}`                },                body: JSON.stringify({ email, username })            });            if (response.ok) {                document.getElementById("newUserEmail").value = "";                document.getElementById("newUsername").value = "";                await loadUserList();                document.getElementById("message").innerText = "User added successfully";            } else {                const error = await response.text();                document.getElementById("message").innerText = `Failed to add user: ${error}`;            }        } catch (error) {            console.error("Add user error:", error);            document.getElementById("message").innerText = "Failed to add user";        }    }    async function loadUserList() {        try {            const response = await fetch(`${API_URL}/users`, {                headers: {                    "Authorization": `Bearer ${currentToken}`                }            });            if (response.ok) {                const users = await response.json();                const userListElement = document.getElementById("userList"); // <tbody> for the table                userListElement.innerHTML = ""; // Clear previous data                Object.entries(users).forEach(([email, details]) => {                    const row = document.createElement("tr");                    row.innerHTML = `                        <td>${email}</td>                        <td>${details.username}</td>                        <td>${details.role}</td>                        <td>${details.counter}</td>                    `;                    userListElement.appendChild(row);                });            }        } catch (error) {            console.error("Load user list error:", error);            document.getElementById("message").innerText = "Failed to load user list";        }    }    async function checkAuth() {        const urlParams = new URLSearchParams(window.location.search);        const token = urlParams.get('token') || localStorage.getItem("jwtToken");        const email = urlParams.get('email') || localStorage.getItem("email");        const browserId = getBrowserId();        if (!token) {            return showLogin();        }        try {            const response = await fetch(`${API_URL}/validate?token=${token}&browserId=${browserId}`);            const data = await response.json();            if (data.token) {                currentToken = data.token;                currentUserRole = data.role;                localStorage.setItem("jwtToken", data.token);                localStorage.setItem("email", email);                localStorage.setItem("userRole", data.role);                if (data.role === "ADMIN") {                    showAdminView(data);                    await loadUserList();                } else {                    showUserView(data);                }                if (urlParams.has('token')) {                    window.history.replaceState({}, document.title, window.location.pathname);                }            } else {                clearLocalStorage();                showLogin();            }        } catch (error) {            clearLocalStorage();            showLogin();        }    }    function showAdminView(data) {        document.getElementById("loginForm").style.display = "none";        document.getElementById("userSection").style.display = "none";        document.getElementById("adminSection").style.display = "block";        document.getElementById("adminUser").innerText = data.username;        document.getElementById("adminJwtToken").innerText = currentToken;        document.getElementById("adminCounter").innerText = data.counter;        document.getElementById("message").innerText = "";    }    function showUserView(data) {        document.getElementById("loginForm").style.display = "none";        document.getElementById("adminSection").style.display = "none";        document.getElementById("userSection").style.display = "block";        document.getElementById("userUsername").innerText = data.username;        document.getElementById("userJwtToken").innerText = currentToken;        document.getElementById("userCounter").innerText = data.counter;        document.getElementById("message").innerText = "";    }    function showLogin() {        document.getElementById("loginForm").style.display = "block";        document.getElementById("adminSection").style.display = "none";        document.getElementById("userSection").style.display = "none";        document.getElementById("message").innerText = "";        document.getElementById("emailSentMessage").style.display = "none";        clearLocalStorage();    }    function clearLocalStorage() {        localStorage.removeItem("jwtToken");        localStorage.removeItem("email");        localStorage.removeItem("userRole");        currentToken = null;        currentUserRole = null;    }    function getBrowserId() {        let browserId = localStorage.getItem('browserId');        if (!browserId) {            browserId = 'browser_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);            localStorage.setItem('browserId', browserId);        }        return browserId;    }    async function incrementCounter() {        const token = localStorage.getItem("jwtToken");        if (!token) return;        try {            const response = await fetch(`${API_URL}/increment`, {                method: "POST",                headers: {                    "Content-Type": "application/json"                },                body: JSON.stringify({ token })            });            const data = await response.json();            if (data.success) {                document.getElementById(currentUserRole === "ADMIN" ? "adminCounter" : "userCounter").textContent = data.count;                localStorage.setItem('counterUpdate', data.count.toString());                if (currentUserRole === "ADMIN") {                    await loadUserList(); // Refresh user list to show updated counters                }            }        } catch (error) {            console.error("Error incrementing counter:", error);        }    }    async function logout(logoutAll) {        const email = localStorage.getItem("email");        const browserId = getBrowserId();        try {            const response = await fetch(`${API_URL}/logout`, {                method: "POST",                headers: {                    "Content-Type": "application/json"                },                body: JSON.stringify({                    username: email,                    browserId: browserId,                    logoutAll: logoutAll                })            });            const data = await response.json();            if (data.success) {                clearLocalStorage();                if (logoutAll) {                    localStorage.removeItem("browserId");                }                showLogin();                localStorage.setItem('authEvent', Date.now().toString());            }        } catch (error) {            console.error("Logout error:", error);            document.getElementById("message").innerText = "Logout failed!";        }    }    // Event listeners    window.addEventListener('storage', (event) => {        if (event.key === 'authEvent') {            checkAuth();        } else if (event.key === 'counterUpdate' && currentUserRole === 'ADMIN') {            loadUserList();        }    });    document.addEventListener('DOMContentLoaded', checkAuth);</script></body></html>